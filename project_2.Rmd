---
title: "Team 12 - Hot Cocoa Codesters Project 1"
author: "Grace Chang, Seungwan Kim, Riley C Maher, Sage O'Toole, Jenna Kay Probst"
date: "2/21/2021"
output:
  html_document:
    number_sections: True
    toc: True
    toc_float: True
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Project 2

Our objective is to identify arbitrage opportunities. Are there elements that the market does not consider a risk factor - but it actually is? Looking in the opposite direction - are there elements that market considers a risk factor but actually it isn’t.

## Importing Packages

```{r}
library(gmodels)
```
## Importing Data
```{r}
listings <- read.csv('ProjectA_Listings2013.csv', stringsAsFactors = TRUE)
head(listings)
```

```{r}
str(listings)
```


## Data Cleaning
```{r}
# Dropping redundant columns and columns with too many character factor levels 
listings = subset(listings, select = -c(borrower_city, borrower_state, loan_status, first_recorded_credit_line, loan_origination_date, occupation))

# Check the number of NA in each variables
# sapply(listings, function(x) sum(is.na(x)))

# Cleaning NA values
# listings$months_employed <- ifelse(is.na(listings$months_employed),0,listings$months_employed)

############################################################################################################

listings$months_employed[is.na(listings$months_employed)] <- mean(listings$months_employed, na.rm=TRUE)

############################################################################################################

# Converting logical values to binary 
cols <- sapply(listings, is.logical)
listings[,cols] <- lapply(listings[,cols], as.numeric)

head(listings)

# Comments from office hour
# We may want to try to change NA value to 0 in months_employed and in installments balance
# kEEP THE NA VALUE AND ONLY REMOVED ALL INSIGNIFICANT VARIABLES. (SUGGESTION)
# After that, run the code again, and check whether NA value disappeared (Some of predictor variables have NA values may be significant, so show the works whether those are significant or not)
```

## Linear Regression

A linear regression model to determine how interest rate for loans is determined. Essentially, we are getting an idea of what the market considers “credit risks”. We get a sense of how much interest rate premium is demanded by the market for compensating for a specific credit risk.

```{r}
listings_lm <- listings

############################################################################################################

# Dummy Variable Creation
listings_lm <- as.data.frame(model.matrix(~.-1, listings_lm))

############################################################################################################


linear1 <- lm(borrower_rate ~ ., data=listings_lm)
summary(linear1)
# income_range and income_range_description were not significant which is odd
# ALL NOT SIGNIFICANT: months_employed, current_delinquencies, delinquencies_last7_years, public_records_last10_years, public_records_last12_months, credit_lines_last7_years, installment_balance, real_estate_balance, revolving_balance, real_estate_payment, revolving_available_percent, total_trade_items, satisfactory_accounts, now_delinquent_derog, was_delinquent_derog
```
```{r}
# listings_lm = subset(listings_lm, select = -c(income_range, income_range_description, months_employed, current_delinquencies, delinquencies_last7_years, public_records_last10_years, public_records_last12_months, credit_lines_last7_years, installment_balance, real_estate_balance, revolving_balance, real_estate_payment, revolving_available_percent, total_trade_items, satisfactory_accounts, now_delinquent_derog, was_delinquent_derog))

############################################################################################################

listings_lm = subset(listings_lm, select = -c(delinquencies_over90_days, delinquencies_over60_days, was_delinquent_derog, now_delinquent_derog, satisfactory_accounts, total_trade_items, revolving_available_percent, real_estate_payment, revolving_balance, real_estate_balance, installment_balance, amount_delinquent, current_delinquencies, delinquencies_last7_years, public_records_last10_years, public_records_last12_months, credit_lines_last7_years, months_employed, income_verifiable, dti_wprosper_loan, `employment_status_descriptionFull-time`, `employment_status_descriptionNot employed`, `employment_status_descriptionOther`, `employment_status_descriptionPart-time`, `employment_status_descriptionRetired`, `income_range_descriptionNot employed`, `income_range_description$25,000-49,999`, `income_range_description$50,000-74,999`, income_range, `income_range_description$1-24,999`, `scorex702-723`, `scorex690-701`, `loan_status_descriptionDEFAULTED`))

############################################################################################################

linear2 <- lm(borrower_rate ~ ., data=listings_lm)
summary(linear2)

# ALL NOT SIGNIFICANT: stated_monthly_income, current_credit_lines, delinquencies_over60_days, delinquencies_over90_days
```

```{r}
# listings_lm = subset(listings_lm, select = -c(stated_monthly_income, current_credit_lines, delinquencies_over60_days, delinquencies_over90_days))

############################################################################################################

listings_lm = subset(listings_lm, select = -c(current_credit_lines, monthly_debt, `income_range_description$75,000-99,999`))

############################################################################################################

linear3 <- lm(borrower_rate ~ ., data=listings_lm)
summary(linear3)

# Not all factors of scorex, employment_status_description are significant
# income_verifiable, dti_wprosper_loan are only significant at p-value < 0.1
```

```{r}
############################################################################################################

listings_lm = subset(listings_lm, select = -c(stated_monthly_income))

linear4 <- lm(borrower_rate ~ ., data=listings_lm)
summary(linear4)

############################################################################################################
```

Defaulted Loans not significant. scorex690-701 and scorex702-723 not significant. income_range
 not significant. income_range_description\$1-24,999, income_range_description$25,000-49,999,
income_range_description\$50,000-74,999, income_range_description$75,000-99,999, income_range_descriptionNot employed not significant. income_verifiable not significant. dti_wprosper_loan not significant. Only self-employed employment status significant. months_employed not significant. monthly_debt not significant. Any delinquencies not significant. Any public records not significant. Only open_credit_lines significant. installment_balance not significant. real_estate_balance not significant. revolving_balance not significant. real_estate_payment not significant. total_trade_items not significant. satisfactory_accounts not significant. now_delinquent_derog not significant. was_delinquent_derog not significant.

With the +100,000 income category being significant, we can assume that at higher income levels, the rates are pretty much set. Only when we get into the lower to mid range incomes do the rates have to be more granular. With the credit score range of 690-723 not being significant, we can assume the majority of borrowers have scores in that range, making the rates for that range set. Only self-employed of the employment statuses was significant in determining the borrower rate. This could be because a self-employed person could have a less secure amount and frequency when compared to a full-time or part-time employee, making them unpredictable. Delinquencies were also not significant, from this we can probably assume some multicollinearity with other variables. On its own, delinquencies would probably have a significant effect on the borrower rate, but when coupled with credit score, the delinquencies are not a strong predictor (same thing with defaulted loans, probably).


## Logistic Regression

A logistic model of what factors lead to a loan default. Essentially we want to check our understanding from the last model. All the items that the last model showed as credit risks leading to compensatory adjustment in interest rate - do those items really cause defaults. Are there other items which cause default but which does not show in Model 1?

```{r}
# we gotta solve for loan_status, but I bet we gotta change this column to default (1) or not (0)
# even though there are four options (defaulted, chargeoff, completed, current)
# From the internet: The term "charge off" means that the original creditor has given up on being repaid according to the original terms of the loan. It considers the remaining balance to be bad debt, but that doesn't mean you no longer owe the amount that has not been repaid.

listings_glm <- listings
listings_glm <- subset(listings_glm, loan_status_description != "CURRENT") #Removed loans still pending

# Assigned 1 if loan defaulted or chargedback, 0 if completed
listings_glm$loan_status_description <- ifelse(listings_glm$loan_status_description == "COMPLETED", 0, 1) 

############################################################################################################

# Dummy Variable Creation
listings_glm <- as.data.frame(model.matrix(~.-1, listings_glm))

############################################################################################################

head(listings_glm)
```

```{r}
log_m1 <- glm(loan_status_description ~ ., data= listings_glm)
summary(log_m1)
#ALL NOT SIGNIFICANT: number_of_days, amount_funded, borrower_rate, listing_monthly_payment, scorex, listing_category_id, income_verifiable, income_range, income_range_description, stated_monthly_income, dti_wprosper_loan, months_employed, lender_indicator, current_delinquencies, delinquencies_last7_years, public_records_last10_years, credit_lines_last7_years, inquiries_last6_months, amount_delinquent, current_credit_lines, open_credit_lines, bankcard_utilization, installment_balance, real_estate_balance, revolving_balance, real_estate_payment, total_inquiries, satisfactory_accounts, was_delinquent_derog, delinquencies_over30_days, delinquencies_over60_days, is_homeowner
```
```{r}
# #removing insignificant variables 
# listings_glm = subset(listings_glm, select = -c(number_of_days, amount_funded, borrower_rate, listing_monthly_payment, scorex, listing_category_id, income_verifiable, income_range, income_range_description, stated_monthly_income, dti_wprosper_loan, months_employed, lender_indicator, current_delinquencies, delinquencies_last7_years, public_records_last10_years, credit_lines_last7_years, inquiries_last6_months, amount_delinquent, current_credit_lines, open_credit_lines, bankcard_utilization, installment_balance, real_estate_balance, revolving_balance, real_estate_payment, total_inquiries, satisfactory_accounts, was_delinquent_derog, delinquencies_over30_days, delinquencies_over60_days, is_homeowner))

############################################################################################################

listings_glm = subset(listings_glm, select = -c(delinquencies_over60_days, delinquencies_over90_days, is_homeowner, installment_balance, real_estate_balance, revolving_balance,real_estate_payment, revolving_available_percent, total_inquiries, total_trade_items, satisfactory_accounts, now_delinquent_derog, was_delinquent_derog, amount_delinquent, current_credit_lines, open_credit_lines, credit_lines_last7_years, current_delinquencies, delinquencies_last7_years, public_records_last10_years, months_employed, `employment_status_descriptionPart-time`, employment_status_descriptionRetired, `income_range_description$25,000-49,999`, `income_range_description$50,000-74,999`, `income_range_description$75,000-99,999`, `income_range_descriptionNot employed`, stated_monthly_income, income_verifiable, dti_wprosper_loan, `employment_status_descriptionFull-time`, `income_range_description$1-24,999`, `scorex600-619`, `scorex620-639`, `scorex640-649`, `scorex650-664`, `scorex665-689`, `scorex690-701`, `scorex702-723`, `scorex724-747`, `scorex748-777`, `scorex778+`, prosper_ratingD, prosper_ratingE, prosper_ratingHR))

############################################################################################################
```

```{r}
log_m2 <- glm(loan_status_description ~., data = listings_glm)
summary(log_m2)
#ALL NOT SIGNIFICANT: monthly_debt, revolving_available_percent, now_delinquent_derog, delinquencies_over90_days
```

```{r}
# #removing insignificant variables 
# listings_glm = subset(listings_glm, select = -c(monthly_debt, revolving_available_percent, now_delinquent_derog, delinquencies_over90_days, prosper_ratingC, prosper_ratingB, prosper_ratingAA))

############################################################################################################

listings_glm = subset(listings_glm, select = -c(delinquencies_over30_days, bankcard_utilization, `employment_status_descriptionSelf-employed`))

############################################################################################################

```


```{r}
log_m3 <- glm(loan_status_description~ ., data = listings_glm)
summary(log_m3)
```


# Didn't we do this? (Below)

```{r}
# # From office hour
# ## Response Variable: default: some predictor variables are changed in terms of 'significant level'.
# 
# # We could start the logistic regression model from beginning, with 'default' as the response variable
# log_m3 <- glm(default~ ., data = listings_glm)
# summary(log_m3)
```




# Test
```{r}
# prdictVar <- predict(log_m3, type='response')
# predictBin <- ifelse(prdictVar > 0.5, 1, 0)
# 
# ## Almost correct, but the arguments do not have the same length. Don't know how to modify it
# confusionMatrix <- table(prd=predictBin, act=listings$borrower_rate)

############################################################################################################

test_set <- sample(1:nrow(listings_glm), 6709)
listings_train <- listings_glm[-test_set, -3]
listings_test <- listings_glm[test_set, -3]

train_set_labels <- listings_glm[-test_set, 'loan_status_description']
test_set_labels <- listings_glm[test_set, 'loan_status_description']

############################################################################################################
```

```{r}
############################################################################################################

prediction <- predict(log_m3, newdata = listings_test, type = "response")

CrossTable(x = test_set_labels, y = as.numeric(prediction>0.5),
           prop.chisq=FALSE)

############################################################################################################
```
















