---
title: "Team 12 - Hot Cocoa Codesters Project 1"
author: "Grace Chang, Seungwan Kim, Riley C Maher, Sage O'Toole, Jenna Kay Probst"
date: "2/21/2021"
output:
  html_document:
    number_sections: True
    toc: True
    toc_float: True
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Project 2: Prosper Data Analysis

Our objective is to identify arbitrage opportunities in the prosper marketplace. A linear regression can be used to identify what the market considers credit risks. A logistic regression can be used to identify the real factors that lead to defaults on loans. Comparing these findings will reveal what elements the market fails to recognize as a risk factor and which elements it considers risks but there actually isn't any risk.

# Data Importing & Cleaning

## Importing Packages

```{r}
library(gmodels)
```

## Importing Data
```{r}
listings <- read.csv('ProjectA_Listings2013.csv', stringsAsFactors = TRUE)
head(listings)
```

```{r}
str(listings)
```


## Data Cleaning
```{r}
# Dropping redundant columns and columns with too many character factor levels 
listings = subset(listings, select = -c(borrower_city, borrower_state, loan_status, first_recorded_credit_line, loan_origination_date, occupation))

# Check the number of NA in each variables
colSums(is.na(listings))
sapply(listings, function(x) sum(is.na(x)))

# Cleaning NA values
listings$months_employed[is.na(listings$months_employed)] <- mean(listings$months_employed, na.rm=TRUE)

# Converting logical values to binary 
cols <- sapply(listings, is.logical)
listings[,cols] <- lapply(listings[,cols], as.numeric)

head(listings)

# Comments from office hour
# We may want to try to change NA value to 0 in months_employed and in installments balance
# kEEP THE NA VALUE AND ONLY REMOVED ALL INSIGNIFICANT VARIABLES. (SUGGESTION)
# After that, run the code again, and check whether NA value disappeared (Some of predictor variables have NA values may be significant, so show the works whether those are significant or not)
```

# Linear Regression

A linear regression model to determine how interest rate for loans is determined. This gives an idea of what the market considers “credit risks” and how much interest rate premium is demanded by the market for compensating for a specific credit risk.

```{r}
listings_lm <- listings

############################################################################################################

# Dummy Variable Creation
listings_lm <- as.data.frame(model.matrix(~.-1, listings_lm))

############################################################################################################


linear1 <- lm(borrower_rate ~ ., data=listings_lm)
summary(linear1)
# income_range and income_range_description were not significant which is odd
# ALL NOT SIGNIFICANT: months_employed, current_delinquencies, delinquencies_last7_years, public_records_last10_years, public_records_last12_months, credit_lines_last7_years, installment_balance, real_estate_balance, revolving_balance, real_estate_payment, revolving_available_percent, total_trade_items, satisfactory_accounts, now_delinquent_derog, was_delinquent_derog
```
```{r}
# listings_lm = subset(listings_lm, select = -c(income_range, income_range_description, months_employed, current_delinquencies, delinquencies_last7_years, public_records_last10_years, public_records_last12_months, credit_lines_last7_years, installment_balance, real_estate_balance, revolving_balance, real_estate_payment, revolving_available_percent, total_trade_items, satisfactory_accounts, now_delinquent_derog, was_delinquent_derog))

############################################################################################################

listings_lm = subset(listings_lm, select = -c(delinquencies_over90_days, delinquencies_over60_days, was_delinquent_derog, now_delinquent_derog, satisfactory_accounts, total_trade_items, revolving_available_percent, real_estate_payment, revolving_balance, real_estate_balance, installment_balance, amount_delinquent, current_delinquencies, delinquencies_last7_years, public_records_last10_years, public_records_last12_months, credit_lines_last7_years, months_employed, income_verifiable, dti_wprosper_loan, `employment_status_descriptionFull-time`, `employment_status_descriptionNot employed`, `employment_status_descriptionOther`, `employment_status_descriptionPart-time`, `employment_status_descriptionRetired`, `income_range_descriptionNot employed`, `income_range_description$25,000-49,999`, `income_range_description$50,000-74,999`, income_range, `income_range_description$1-24,999`, `scorex702-723`, `scorex690-701`, `loan_status_descriptionDEFAULTED`))

############################################################################################################

linear2 <- lm(borrower_rate ~ ., data=listings_lm)
summary(linear2)

# ALL NOT SIGNIFICANT: stated_monthly_income, current_credit_lines, delinquencies_over60_days, delinquencies_over90_days
```

```{r}
# listings_lm = subset(listings_lm, select = -c(stated_monthly_income, current_credit_lines, delinquencies_over60_days, delinquencies_over90_days))

############################################################################################################

listings_lm = subset(listings_lm, select = -c(current_credit_lines, monthly_debt, `income_range_description$75,000-99,999`))

############################################################################################################

linear3 <- lm(borrower_rate ~ ., data=listings_lm)
summary(linear3)

# Not all factors of scorex, employment_status_description are significant
# income_verifiable, dti_wprosper_loan are only significant at p-value < 0.1
```

```{r}
############################################################################################################

listings_lm = subset(listings_lm, select = -c(stated_monthly_income))

linear4 <- lm(borrower_rate ~ ., data=listings_lm)
summary(linear4)

############################################################################################################
```


With the +100,000 income category being significant, we can assume that at higher income levels, the rates are pretty much set. Only when we get into the lower to mid range incomes do the rates have to be more granular. With the credit score range of 690-723 not being significant, we can assume the majority of borrowers have scores in that range, making the rates for that range set. Only self-employed of the employment statuses was significant in determining the borrower rate. This could be because a self-employed person could have a less secure amount and frequency when compared to a full-time or part-time employee, making them unpredictable. Delinquencies were also not significant, from this we can probably assume some multicollinearity with other variables. On its own, delinquencies would probably have a significant effect on the borrower rate, but when coupled with credit score, the delinquencies are not a strong predictor (same thing with defaulted loans, probably).


# Logistic Regression

A logistic model of what factors lead to a loan default. This reveals what factors really cause defaults.

```{r}
# we gotta solve for loan_status, but I bet we gotta change this column to default (1) or not (0)
# even though there are four options (defaulted, chargeoff, completed, current)
# From the internet: The term "charge off" means that the original creditor has given up on being repaid according to the original terms of the loan. It considers the remaining balance to be bad debt, but that doesn't mean you no longer owe the amount that has not been repaid.

listings_glm <- listings
listings_glm <- subset(listings_glm, loan_status_description != "CURRENT") #Removed loans still pending

# Assigned 1 if loan defaulted or chargedback, 0 if completed
listings_glm$loan_status_description <- ifelse(listings_glm$loan_status_description == "COMPLETED", 0, 1) 

############################################################################################################

# Dummy Variable Creation
listings_glm <- as.data.frame(model.matrix(~.-1, listings_glm))

############################################################################################################

head(listings_glm)
```

```{r}
log_m1 <- glm(loan_status_description ~ ., data= listings_glm)
summary(log_m1)
#ALL NOT SIGNIFICANT: number_of_days, amount_funded, borrower_rate, listing_monthly_payment, scorex, listing_category_id, income_verifiable, income_range, income_range_description, stated_monthly_income, dti_wprosper_loan, months_employed, lender_indicator, current_delinquencies, delinquencies_last7_years, public_records_last10_years, credit_lines_last7_years, inquiries_last6_months, amount_delinquent, current_credit_lines, open_credit_lines, bankcard_utilization, installment_balance, real_estate_balance, revolving_balance, real_estate_payment, total_inquiries, satisfactory_accounts, was_delinquent_derog, delinquencies_over30_days, delinquencies_over60_days, is_homeowner
```
```{r}
# #removing insignificant variables 
# listings_glm = subset(listings_glm, select = -c(number_of_days, amount_funded, borrower_rate, listing_monthly_payment, scorex, listing_category_id, income_verifiable, income_range, income_range_description, stated_monthly_income, dti_wprosper_loan, months_employed, lender_indicator, current_delinquencies, delinquencies_last7_years, public_records_last10_years, credit_lines_last7_years, inquiries_last6_months, amount_delinquent, current_credit_lines, open_credit_lines, bankcard_utilization, installment_balance, real_estate_balance, revolving_balance, real_estate_payment, total_inquiries, satisfactory_accounts, was_delinquent_derog, delinquencies_over30_days, delinquencies_over60_days, is_homeowner))

############################################################################################################

listings_glm = subset(listings_glm, select = -c(delinquencies_over60_days, delinquencies_over90_days, is_homeowner, installment_balance, real_estate_balance, revolving_balance,real_estate_payment, revolving_available_percent, total_inquiries, total_trade_items, satisfactory_accounts, now_delinquent_derog, was_delinquent_derog, amount_delinquent, current_credit_lines, open_credit_lines, credit_lines_last7_years, current_delinquencies, delinquencies_last7_years, public_records_last10_years, months_employed, `employment_status_descriptionPart-time`, employment_status_descriptionRetired, `income_range_description$25,000-49,999`, `income_range_description$50,000-74,999`, `income_range_description$75,000-99,999`, `income_range_descriptionNot employed`, stated_monthly_income, income_verifiable, dti_wprosper_loan, `employment_status_descriptionFull-time`, `income_range_description$1-24,999`, `scorex600-619`, `scorex620-639`, `scorex640-649`, `scorex650-664`, `scorex665-689`, `scorex690-701`, `scorex702-723`, `scorex724-747`, `scorex748-777`, `scorex778+`, prosper_ratingD, prosper_ratingE, prosper_ratingHR))

############################################################################################################
```

```{r}
log_m2 <- glm(loan_status_description ~., data = listings_glm)
summary(log_m2)
#ALL NOT SIGNIFICANT: monthly_debt, revolving_available_percent, now_delinquent_derog, delinquencies_over90_days
```

```{r}
# #removing insignificant variables 
# listings_glm = subset(listings_glm, select = -c(monthly_debt, revolving_available_percent, now_delinquent_derog, delinquencies_over90_days, prosper_ratingC, prosper_ratingB, prosper_ratingAA))

############################################################################################################

listings_glm = subset(listings_glm, select = -c(delinquencies_over30_days, bankcard_utilization, `employment_status_descriptionSelf-employed`))

############################################################################################################

```


```{r}
log_m3 <- glm(loan_status_description~ ., data = listings_glm)
summary(log_m3)
```


 Didn't we do this? (Below)

```{r}
# # From office hour
# ## Response Variable: default: some predictor variables are changed in terms of 'significant level'.
# 
# # We could start the logistic regression model from beginning, with 'default' as the response variable
# log_m3 <- glm(default~ ., data = listings_glm)
# summary(log_m3)
```

# Test
```{r}
# prdictVar <- predict(log_m3, type='response')
# predictBin <- ifelse(prdictVar > 0.5, 1, 0)
# 
# ## Almost correct, but the arguments do not have the same length. Don't know how to modify it
# confusionMatrix <- table(prd=predictBin, act=listings$borrower_rate)

############################################################################################################

test_set <- sample(1:nrow(listings_glm), 6709)
listings_train <- listings_glm[-test_set, -3]
listings_test <- listings_glm[test_set, -3]

train_set_labels <- listings_glm[-test_set, 'loan_status_description']
test_set_labels <- listings_glm[test_set, 'loan_status_description']

############################################################################################################
```

```{r}
############################################################################################################

prediction <- predict(log_m3, newdata = listings_test, type = "response")

CrossTable(x = test_set_labels, y = as.numeric(prediction>0.5),
           prop.chisq=FALSE)

#confusionMatrix(prediction, test_set_labels)

############################################################################################################
```
## Logistic Regression Analysis

For our logistic regression we choose to compare the results of the regression with a set of test data. The martix above shows our log regression model to have an accuracy of 91.8% which would likely be satisfactory for predicting defaults for a real loan company. 

Despite the many, many variables analyzed, only the following are significant: 
* principal balance
* prosper rating B , C
* income range 100,000+
* not employed
* lender indicator
* monthly debt
* public records last 12 months
* total open revolving accounts

The variables provide valuable information. The proposer rating system may be inefficient, with only two of the seven ratings (B and C) being valuable to predict defaults. The income and employment results show that they are both important, but less detail on employment would be sufficient since the only factor that was significant was whether or not the loan taker had any type of employment or not. Unsurprisingly, the amount of the loan and the amount of debt the loan taker has is significant and thus should be calculated and monitored closely. Interestingly, many of the significant factors are used to decide a persons credit score (total open accounts, debt) but credit score itself was not significant, giving reason to study credit score more closely to see where its accuracy can be improved too.  

# Arbitrage Opportunities

Identifying differences in credit risks found from the linear regression model and default risks found from the logistic model finds inefficiencies in the market and an opportunity to invest. The linear regression found the following factors lead to higher loan interest rates:

* prosper rating B, C, D, E, HR
* listing term
* listing monthly payment
* scorex 600-689
* income range 100,000+
* lender indicator
* bankcard utilization
* total open revolving accounts
* total inquiries
* delinquencies

However, the logistic model found the following were the factors that actually were risk factors resulting in defaults on loans:

* principal balance
* prosper rating B , C
* income range 100,000+
* not employed
* lender indicator
* monthly debt
* public records last 12 months
* total open revolving accounts

The differences in these lists indicates possible inefficiencies in the loan market. It should be noted these differences could also be attributed to possibly multicollinearity or insignificance in the models. The following factors the market does not consider a risk factor but it actually is (not significant in the linear regression model but has significant impact in the logistic model):

* principal balance
* not employed
* monthly debt
* public records last 12 months

The market considers the following factors a risk factor but it actually isn't (significant in the linear regression model but not in the logistic model):

* listing term
* listed monthly payment
* score 600-689
* bankcard utilization
* delinquencies

These loans where the market considers risk that the logistic model doesn't think is there provide an investment opportunity. It is recommended to invest in these loans because you could expect a better return than what the market predicts. These loans have a higher interest return and (based on our models) will not default as much as the market suggests.






